#ifndef __MEMORY_SCIF_H
#define __MEMORY_SCIF_H


#include "scif2_define.h"
#include "common_define.h"

#define PORT_UDP_RECON      1700
#define PORT_UDP_REPLY      1701


//-------------------------------
struct POLLING_QUEUE
{
	unsigned char   WriteAddr;
    unsigned char   ReadAddr;
    LK_TRANSACTION  Trans[MAX_LOOP_SIZE];
};
                            
//-------------------------------
struct DIRECT_QUEUE
{
	unsigned char   WriteAddr;
    unsigned char   ReadAddr;
    LK_TRANSACTION  Trans[MAX_DIRECT_SIZE];
};

#define MAX_CONTROLLER_NUM_PER_PAGE    30    //å‘ Media è®€å–æ§åˆ¶å™¨æ¸…å–®æ™‚ï¼Œåˆ†é å‘ Media å–å¾—è©³è³‡æ–™ï¼Œæ¯é çš„æ•¸é‡

//----------æœ¬åœ°ç«¯åµæ¸¬çš„ä¸»æ©Ÿè³‡è¨Š
struct LOCAL_INFO
{
	unsigned short        Count;
    LOCAL_CONTROLLER_INFO Hosts[MAX_CONTROLLER_NUM_PER_MAKER];
};



//------------ å°åª’ä»‹ä¸»æ©Ÿçš„ç‹€æ…‹
enum CONNECT_STEP
{
    CONNECT_STEP_IDLE                       =0,

    CONNECT_STEP_GET_MY_IP_PORT             =21,     //å–å¾— Talk ä½¿ç”¨çš„å¤–éƒ¨ IP+Port
    CONNECT_STEP_GET_MY_IP_PORT_CHECK       =22,     //

    CONNECT_STEP_SET_REQ_HOLE_FOR_SURE      =31,     //è¨­å®š ç¢ºå®š Portçš„é æ¸¬ Port
    CONNECT_STEP_SET_REQ_HOLE_FOR_PREDIT    =32,     //è¨­å®šä¸ç¢ºå®š Portçš„é æ¸¬ Port

    CONNECT_STEP_REOPEN_PORT                =41,     //é‡æ–°é–‹å•Ÿä¸€å€‹ Port

    CONNECT_STEP_TRY_HOLE_START             =51,
    CONNECT_STEP_REQ_OPEN_REMOTE_HOLE       =52,     //è«‹æ±‚ Media é€šçŸ¥é–‹æ´
    CONNECT_STEP_REQ_OPEN_REMOTE_HOLE_CHECK =53,
	CONNECT_STEP_CONNECT_LOCAL              =54,
	CONNECT_STEP_CONNECT_REMOTE             =55,
	CONNECT_STEP_CONNECT_CHECK              =56,
    CONNECT_STEP_TRY_HOLE_CHECK             =57,
    CONNECT_STEP_DISCONNECT                 =58,
    CONNECT_STEP_DISCONNECT_CHECK           =59,

    CONNECT_STEP_CHECK_CONNECT_FAIL         =61,

    CONNECT_STEP_GET_MAC                    =71, 
    CONNECT_STEP_GET_MAC_CHECK              =72,
    CONNECT_STEP_GET_RECON_SETTING          =73,
    CONNECT_STEP_GET_RECON_SETTING_CHECK    =74,
    CONNECT_STEP_SET_RECON_SETTING          =75,
    CONNECT_STEP_SET_RECON_SETTING_CHECK    =76,

    CONNECT_STEP_DONE                       =99,
};



enum CONNECT_ACTION
{                      
    CONNECT_ACTION_IDLE                 = 0x00,
    CONNECT_ACTION_TO_CONNECT           = 0x11,          //
    CONNECT_ACTION_TO_DISCONNECT        = 0x22,
};


enum FTP_ACTION
{
    FTP_ACTION_IDLE                 = 0x00,
    FTP_ACTION_TO_UPLOAD_FILE       = 0x11,
    FTP_ACTION_TO_DOWNLOAD_FILE     = 0x12, 
    FTP_ACTION_TO_DELETE_FILE       = 0x13,
    FTP_ACTION_TO_LIST_FILE         = 0x21,
    FTP_ACTION_TO_MAKE_DIR          = 0x22,
    FTP_ACTION_TO_UPLOAD_FILES      = 0x31,
    FTP_ACTION_TO_DOWNLOAD_FILES    = 0x32,  
    FTP_ACTION_TO_DELETE_FILES      = 0x33,
};

//---------- é—œæ–¼åª’ä»‹ä¸»æ©Ÿçš„æ‰€æœ‰è³‡è¨Š
#define MAX_STEP 32

struct PROTOCOL_SECTION
{
    unsigned short  PkgID;
    unsigned char   TranType;
    unsigned char   TranIndex;
    unsigned int   RxUseByteCnt;
    unsigned int   RxUnuseByteCnt;
    unsigned int   RxCrcPkgCnt;
    unsigned int   RxPkgCnt;
    unsigned short  RxUnExpectCnt;     //éé æœŸæ”¶åˆ°çš„å°åŒ…
    unsigned short  RxErrFmtCnt;     //æ ¼å¼éŒ¯èª¤çš„å°åŒ…
    //unsigned int   TxByteCnt;
    unsigned int   TxPkgCnt;
    unsigned int   TxPkgRetryCnt;      //
    unsigned int   TxConnectCnt;        //é€£ç·šå°åŒ…é€å‡ºæ¬¡æ•¸
    unsigned int   RxConnectCnt;        //é€£ç·šå°åŒ…æ¥æ”¶æ¬¡æ•¸

    unsigned short  RetryCnt;         //!< é‡é€æ¬¡æ•¸

    unsigned char  TalkTxBufs[MAX_PACKET_SIZE];
    unsigned short TalkTxLens;
    
    unsigned char  *TalkTxBuf;
    unsigned short  TalkTxLen;

#ifdef __CLIENT
	int             fd;               //é€šè¨Š
    unsigned short  TalkRxLenPredit;  //é æ¸¬æ‡‰æ”¶åˆ°å›å‚³çš„è³‡æ–™é•·åº¦
    unsigned char   TalkRxBufs[MAX_PACKET_SIZE];    //!< æ¥æ”¶è³‡æ–™çš„Buf
    unsigned short  TalkRxLens;                     //!< ç›®å‰æ¥æ”¶è³‡æ–™ä½å€ç´¢å¼•
#endif
};

//--------------é€£ç·šé€šè¨Šçš„è³‡è¨Š-------
struct TALK_INFO
{
    int         SoftwareID;        //è»Ÿé«”ID
    //int                ConnectIndex;
    //---å‚³é€ç”¨çš„
    
#ifdef __QT
    QUdpSocket*        Sck;
    QHostAddress       ReconAddr;       // controller address information
#else
    int*               Sck;              //³q°T handle
	struct sockaddr_in ReconAddr;       // controller address information
#endif

    //----Mediaç”¨çš„
    int                MyIPLong;
    int                MyPort;
    int                MyPossiblePortCount;
    int                MyPossiblePort[4];

    //----Combineå°åŒ…çš„æš«å­˜è³‡è¨Š
    unsigned int      DirectReadCombineFlag;
    unsigned int      DirectReadIntNum;
    unsigned int      DirectReadFixNum;
    LK_TARGET         DirectReadInt[INT_CB_SIZE];
    LK_TARGET         DirectReadFix[FIX_CB_SIZE];

    unsigned int      LoopReadCombineFlag;
    unsigned int      LoopReadIntNum;
    unsigned int      LoopReadFixNum;
    LK_TARGET         LoopReadInt[INT_CB_SIZE];
    LK_TARGET         LoopReadFix[FIX_CB_SIZE];

    unsigned int      DirectWriteCombineFlag;
    unsigned int      DirectWriteIntNum;
    unsigned int      DirectWriteFixNum;
    LK_TARGET         DirectWriteInt[INT_CB_SIZE];
    int               DirectWriteIntData[INT_CB_SIZE];
    LK_TARGET         DirectWriteFix[FIX_CB_SIZE];
    double            DirectWriteFixData[INT_CB_SIZE];

    unsigned int      LoopWriteCombineFlag;
    unsigned int      LoopWriteIntNum;
    unsigned int      LoopWriteFixNum;
    LK_TARGET         LoopWriteInt[INT_CB_SIZE];
    LK_TARGET         LoopWriteFix[FIX_CB_SIZE];

    //Connect ç”¨çš„è³‡è¨Š
    CONNECT_ACTION     Action;
    CONNECT_STEP       Step[MAX_STEP];
    unsigned char      StepIndex;
    char               ConnectPwd[16];
    unsigned char      TxBuf[MAX_CONNECT_SIZE];
    unsigned int       TxLen;
    unsigned short     PacketID;
    unsigned short     MaxRetry;        //æœ€å¤§é‡è©¦æ¬¡æ•¸
    unsigned short     RetryCnt;            
    unsigned char      ConnectWaiting;         //!< é€šè¨Šç‹€æ…‹
    unsigned char      TryHoleTimes;   //å˜—è©¦æ‰“æ´å·²ç¶“éçš„æ¬¡æ•¸
    unsigned char      ConnectResponse;

    unsigned int      AliveTxTime;
    unsigned int      AliveRxTime;
    unsigned char      AliveBuf[10];
    unsigned char      ConnState;       //!< é€£ç·šç‹€æ…‹
    unsigned int      ConnectTime;      //æœ¬æ¬¡å°åŒ…çš„å‚³é€æ™‚é–“é»
    unsigned int      ConnectWaitTime;

    ERROR_MSG          ErrRec;           //æœ€å¾Œä¸€æ¬¡çš„éŒ¯èª¤å…§å®¹

    unsigned char      QueueFrom;       //ç›®å‰æ“ä½œçš„Queueä¾†æº
    POLLING_QUEUE      LoopQueue;    //é é¢çš„ PollingQueueè³‡æ–™
    DIRECT_QUEUE       DirectQueue;     //DirectQueue
    LK_TRANSACTION     *pTran;          //ç›®å‰é€šè¨Šè™•ç†ä¸­çš„äº¤æ˜“
    PROTOCOL_SECTION   Section;         //é€šè¨Šå”å®šæ‰€éœ€çš„çµæ§‹è³‡æ–™
    unsigned int       LoopCount;       //loop Queueå¾ªç’°æ¬¡æ•¸
    unsigned int       Timeout;         //é€šè¨Š timeout æ™‚é–“
    unsigned int       ResponseTime;    //æœ€å¾Œä¸€æ¬¡å°åŒ…çš„å›æ‡‰æ™‚é–“
    unsigned int       timeSend;        //æœ¬æ¬¡å°åŒ…çš„å‚³é€æ™‚é–“é»
    unsigned int       timeSpace;       //ä¸Šæ¬¡æ”¶åˆ°è³‡æ–™çš„æ™‚é–“é»
    unsigned char      TalkWaiting;         //!< é€šè¨Šç‹€æ…‹
    unsigned char      TalkState;
    unsigned short     TalkMaxRetry;    //æœ€å¤§é‡è©¦æ¬¡æ•¸

    unsigned char      MAC[6];          //Mac address
    unsigned char      GetMacDone;
    unsigned char      GetSettingDone;
    unsigned char      SetSettingDone;
    unsigned char      SetSettingResult;
    MIRROR_MEMORY      Mem;                 //Mirror memory for Process

};
                     
struct FTP_BLOCK_INFO
{
    unsigned short PacketID;
    unsigned char  TryTimes;     //å‚³é€æ¬¡æ•¸
    unsigned int  WaitTime;
    unsigned short Idx;
    unsigned short Size;
};


enum FTP_STEP
{
	FTP_STEP_SET_MANY               =1,
    FTP_STEP_CHECK_MANY             =2,
    FTP_STEP_REQ_UPLOAD             = 11,
    FTP_STEP_REQ_UPLOAD_CHECK       = 12, 
    FTP_STEP_UPLOAD_MEM             = 13,
    FTP_STEP_UPLOAD_MEM_CHECK       = 14,
    FTP_STEP_TELL_UPLOAD_DONE       = 15,
    FTP_STEP_TELL_UPLOAD_DONE_CHECK = 16,

    FTP_STEP_REQ_DOWNLOAD             = 31,
    FTP_STEP_REQ_DOWNLOAD_CHECK       = 32,
    FTP_STEP_DOWNLOAD_MEM             = 33,
    FTP_STEP_DOWNLOAD_MEM_CHECK       = 34,
    FTP_STEP_TELL_DOWNLOAD_DONE       = 35,
    FTP_STEP_TELL_DOWNLOAD_DONE_CHECK = 36,

    FTP_STEP_REQ_DELETE             = 41,
    FTP_STEP_REQ_DELETE_CHECK       = 42,

    FTP_STEP_REQ_MAKE_DIR         = 51,
    FTP_STEP_REQ_MAKE_DIR_CHECK   = 52,

    FTP_STEP_REQ_LIST              =61,
    FTP_STEP_REQ_LIST_CHECK        =62,
    FTP_STEP_GET_FILE_LIST        =71,
    FTP_STEP_GET_FILE_LIST_CHECK  =72,
    FTP_STEP_DONE                   = 81,
};


struct FTP_INFO
{
    int   State;           //ç‹€æ…‹
    int   Result;          //å‚³é€çµæœ
    int   FtpDone;         //Ftpå·¥ä½œå®Œæˆè¨»è¨˜
    int   LastState;           //ç‹€æ…‹
    int   LastResult;          //å‚³é€çµæœ

    FTP_ACTION      Action;

    //----æª”æ¡ˆå‚³è¼¸è³‡æ–™
    char            Folder;          //æª”æ¡ˆå‚³è¼¸è³‡æ–™å¤¾  
    char            SubFolder[32];   //å­ç›®éŒ„åç¨±
    char            HeadFilter[10];
    char            TailFilter[10];
    char            FileName[32];    //æª”æ¡ˆåç¨±
    char            LocalName[256];  //æª”æ¡ˆåç¨±
    char            DirName[16];
    int    FileSize;
    unsigned char*  pFileMem;
    short  FileCRC;
    int  TotalIdx;
    int  CurrentIdx;

    //----ä¸»æ©Ÿè³‡æ–™å¤¾æª”æ¡ˆæ¸…å–®
    char             FilePath[200];
    int   FileCount;
    int   FileIndex;
    FTP_FILE         FileLists[MAX_FILE_LIST_NUM];
                          
    //----ä¸»æ©Ÿè³‡æ–™å¤¾æª”æ¡ˆæ¸…å–®
    char             LocalPath[200];
    int   LocalFileCount;
    int   LocalFileIndex;
    FTP_FILE         LocalFileLists[MAX_FILE_LIST_NUM];

    //----æª”æ¡ˆå‚³è¼¸æ¸…å–®
    int    TransferCount;
    int    TransferIndex;
    FTP_TRANFER_FILE TransferFiles[MAX_TRANSFER_FILE_COUNT];

	unsigned short  PacketID;
    FTP_STEP        Step[20];
    unsigned char   StepIndex;

    unsigned char   TxBuf[MAX_PACKET_SIZE];
    unsigned short  TxLen;
    unsigned char   TryTimes;
    unsigned int    TimeSend;
    unsigned int    Timeout;
    unsigned int    MaxRetry;

    unsigned char   CmdResult;   //ç›®å‰å‘½ä»¤çš„å›æ‡‰çµæœ 0:æœªæœ‰çµæœ  1:æˆåŠŸ  2:å¤±æ•—  3:é€šè¨Šå¤±æ•—
};

//-------------------------------
struct COMM_SESSION
{
    int     SoftwareID;              //è»Ÿé«”ID
    int     ConnectNum;             //é€£ç·šæ•¸ç›®
    int     DebugLevel;              //é™¤éŒ¯ç­‰ç´š
    unsigned int     ProcCounter;             //Proc è¨ˆæ•¸å™¨

    FUNCTION_SETTING Funcs;                   //åŠŸèƒ½è¨­å®š
    LOCAL_INFO       LocalInfo;               //å€åŸŸç¶²è·¯å…§çš„ä¸»æ©Ÿè³‡è¨Š
    FTP_INFO         FtpInfo;
    int              FtpTalkIdx;

    TALK_INFO       *pTalkInfo;  //è³‡è¨Šé€šè¨Šçš„è³‡è¨Š
    int  MemSizeI;
    int  MemSizeO;
    int  MemSizeC;
    int  MemSizeS;
    int  MemSizeA;
    int  MemSizeR;
    int  MemSizeF;
};

          
extern COMM_SESSION  *pSes;
#ifdef __QT
    extern QUdpSocket* MainSocket;
#else
    extern int*        MainSocket;
#endif
extern int FtpIndex;


#ifdef __QT
    void ClosePort(QUdpSocket *pSck);
    bool OpenPort(QUdpSocket *pSck);
#else
    void ClosePort(int *pSck);
    bool OpenPort(int *pSck);
#endif
void LogTalkError(TALK_INFO *pTalk, int Type);
int WriteOutMessage(TALK_INFO *pTalk, char *Buf, int Len);


int cmdBitWriteN(int SIdx, int type, LK_DEVICE dev, int addr, int num, int *data);
int cmdIntWriteN(int SIdx, int type, LK_DEVICE dev, int addr, int num, int *data);
int cmdFixWriteN(int SIdx, int type, LK_DEVICE dev, int addr, int num, double *data);

int cmdBitReadN(int SIdx, int type, LK_DEVICE dev, int Addrs, int Nums);
int cmdIntReadN(int SIdx, int type, LK_DEVICE dev, int Addrs, int Nums);
int cmdFixReadN(int SIdx, int type, LK_DEVICE dev, int Addrs, int Nums);


int CombineIntWrite(int SIdx, int type, int num, int StIdx);
int CombineFixWrite(int SIdx, int type, int num, int StIdx);

int CombineIntRead(int SIdx, int type, int num, int StIdx);
int CombineFixRead(int SIdx, int type, int num, int StIdx);

int AddDirectQueue(int SIdx, LK_TRANSACTION *pTran);
int AddLoopQueue(int SIdx, LK_TRANSACTION *pTran);



#endif
